name: Supabase Keep Alive (All Projects)

on:
  schedule:
    # Runs Monday and Thursday at 9 AM UTC
    - cron: '0 9 * * 1,4'
  workflow_dispatch: # Manual trigger

jobs:
  ping:
    runs-on: ubuntu-latest

    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Supabase Client
        run: npm install @supabase/supabase-js

      - name: Ping All Supabase Projects
        env:
          # === PROJECT 1: Collision Help ===
          PROJECT_1_NAME: "Collision Help"
          PROJECT_1_URL: ${{ secrets.SUPABASE_URL }}
          PROJECT_1_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          
          # === PROJECT 2: Vaultkeeper ===
          PROJECT_2_NAME: "Vaultkeeper"
          PROJECT_2_URL: ${{ secrets.VAULTKEEPER_SUPABASE_URL }}
          PROJECT_2_KEY: ${{ secrets.VAULTKEEPER_SUPABASE_KEY }}
          
          # === PROJECT 3: Stambaugh Designs ===
          PROJECT_3_NAME: "Stambaugh Designs"
          PROJECT_3_URL: ${{ secrets.STAMBAUGH_SUPABASE_URL }}
          PROJECT_3_KEY: ${{ secrets.STAMBAUGH_SUPABASE_KEY }}
          
          # === PROJECT 4: Jordan Was Here ===
          PROJECT_4_NAME: "Jordan Was Here"
          PROJECT_4_URL: ${{ secrets.JORDAN_SUPABASE_URL }}
          PROJECT_4_KEY: ${{ secrets.JORDAN_SUPABASE_KEY }}
          
        run: |
          node << 'SCRIPT'
          const { createClient } = require('@supabase/supabase-js');

          // Build projects array from environment variables
          const projects = [];
          let i = 1;
          while (process.env[`PROJECT_${i}_NAME`]) {
            const url = process.env[`PROJECT_${i}_URL`];
            const key = process.env[`PROJECT_${i}_KEY`];
            const name = process.env[`PROJECT_${i}_NAME`];

            if (url && key && url !== '' && key !== '') {
              projects.push({ name, url, key });
            } else {
              console.log(`âš ï¸  ${name}: Skipped (missing URL or KEY secret)`);
            }
            i++;
          }

          async function pingProject(project) {
            const startTime = Date.now();
            try {
              const supabase = createClient(project.url, project.key);

              // Try 1: UPDATE keep_alive table (best - proves write access)
              const { error: updateError } = await supabase
                .from('keep_alive')
                .update({ pinged_at: new Date().toISOString() })
                .eq('id', 1);

              if (!updateError) {
                console.log(`âœ… ${project.name}: Ping successful (UPDATE) [${Date.now() - startTime}ms]`);
                return { name: project.name, success: true, method: 'update' };
              }

              // Try 2: SELECT from keep_alive table
              const { data, error: selectError } = await supabase
                .from('keep_alive')
                .select('*')
                .limit(1);

              if (!selectError) {
                console.log(`âœ… ${project.name}: Ping successful (SELECT) [${Date.now() - startTime}ms]`);
                return { name: project.name, success: true, method: 'select' };
              }

              // Try 3: Query any system table to prove DB connectivity
              const { error: healthError } = await supabase
                .from('_realtime')
                .select('*')
                .limit(1)
                .maybeSingle();

              if (!healthError) {
                console.log(`âœ… ${project.name}: Ping successful (health check) [${Date.now() - startTime}ms]`);
                console.log(`   âš ï¸  Note: Create keep_alive table for better tracking`);
                return { name: project.name, success: true, method: 'health', needsTable: true };
              }

              throw new Error(selectError?.message || updateError?.message || 'Unknown error');

            } catch (err) {
              const duration = Date.now() - startTime;
              console.error(`âŒ ${project.name}: FAILED [${duration}ms]`);
              console.error(`   Error: ${err.message}`);
              
              if (err.message.includes('Failed to fetch') || err.message.includes('ENOTFOUND')) {
                console.error(`   â†’ Project may be PAUSED. Unpause at https://app.supabase.com`);
              } else if (err.message.includes('relation') && err.message.includes('does not exist')) {
                console.error(`   â†’ Run the keep_alive SQL migration in this project`);
              }
              
              return { name: project.name, success: false, error: err.message };
            }
          }

          async function main() {
            console.log('');
            console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
            console.log('â•‘           SUPABASE KEEP-ALIVE PING                         â•‘');
            console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log(`  Timestamp: ${new Date().toISOString()}`);
            console.log(`  Projects configured: ${projects.length}`);
            console.log('');

            if (projects.length === 0) {
              console.error('âŒ ERROR: No projects configured with valid credentials!');
              console.error('   Add secrets: {PROJECT}_SUPABASE_URL and {PROJECT}_SUPABASE_KEY');
              process.exit(1);
            }

            console.log('â”€'.repeat(62));
            const results = await Promise.all(projects.map(pingProject));
            console.log('â”€'.repeat(62));

            const successful = results.filter(r => r.success);
            const failed = results.filter(r => !r.success);
            const needsTable = results.filter(r => r.needsTable);

            console.log('');
            console.log(`ðŸ“Š RESULTS: ${successful.length}/${results.length} successful`);

            if (needsTable.length > 0) {
              console.log('');
              console.log('âš ï¸  PROJECTS NEEDING keep_alive TABLE:');
              needsTable.forEach(p => console.log(`   - ${p.name}`));
            }

            if (failed.length > 0) {
              console.log('');
              console.log('âŒ FAILED PROJECTS:');
              failed.forEach(f => console.log(`   - ${f.name}: ${f.error}`));
              console.log('');
              console.log('ðŸ”§ TROUBLESHOOTING:');
              console.log('   1. Unpause projects at https://app.supabase.com');
              console.log('   2. Verify GitHub secrets are correct');
              console.log('   3. Run SQL migration to create keep_alive table');
              process.exit(1);
            }

            console.log('');
            console.log('âœ… All projects pinged successfully!');
          }

          main();
          SCRIPT
